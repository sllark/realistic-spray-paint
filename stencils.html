<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spray + Stencils</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      @font-face {
        font-family: "ArchimotoV01-Regular";
        src: url("assets/fonts/ArchimotoV01-Regular.otf") format("opentype");
        font-weight: 100;
        font-style: normal;
        font-display: swap;
      }
      /* Mobile-first additions for stencil page */
      :root {
        --bg: #e4e1ce;
      }
      html,
      body {
        height: 100%;
      }
      body.stencils {
        /* Use canvas texture background for the whole page */
        background: var(--bg) url("assets/bg-2.webp") center / cover no-repeat
          fixed;
        margin: 0;
        font-family: "ArchimotoV01-Regular", system-ui, -apple-system, Segoe UI,
          Roboto, Helvetica, Arial, sans-serif;
        /* Make body fill the visible viewport on mobile (accounts for URL bar) */
        min-height: 100svh;
      }
      #stencilApp {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        /* Keep content above iOS Safari toolbar */
        padding-bottom: calc(env(safe-area-inset-bottom) + 60px);
        min-height: 100svh;
        height: 100svh;
      }
      .tray {
        position: absolute;
        top: -100px;
        left: 0;
        width: 100%;
        z-index: 9999;
        display: flex;
        justify-content: center;
        gap: 12px;
        /* overflow-x: auto; */
        /* Let taps pass through background to controls beneath; items remain interactive */
        pointer-events: none;
      }
      .tray .stencil-item {
        height: auto;
        max-height: 140px;
        width: 90px;
        cursor: pointer;
        user-select: none;
        touch-action: none;
        object-fit: contain;
        /* Re-enable interaction on the icons themselves */
        pointer-events: auto;
      }
      .tray .stencil-item.girl-stencil {
        max-height: 200px;
        width: 115px;
        transform: rotate(-15deg);
      }
      .tray .stencil-item.heart-stencil {
        width: 85px;
        transform: rotate(5deg);
        margin-top: -21px;
        margin-left: -5px;
      }
      .tray .stencil-item.heart-string-stencil {
        width: 60px;
        transform: rotate(-8deg);
        margin-left: 10px;
        margin-top: -20px;
      }
      /* Loose, page-level stencil the user can park anywhere */
      .loose-stencil {
        position: fixed;
        /* transform: translate(-50%, -50%); */
        /* max-width: 140px; */
        /* max-height: 140px; */
        z-index: 9999;
        user-select: none;
        touch-action: none;
        pointer-events: auto;
      }
      .stencil-chip {
        flex: 0 0 auto;
        padding: 8px 12px;
        border-radius: 18px;
        background: #222;
        color: #fff;
        font-size: 14px;
        user-select: none;
        touch-action: none;
      }
      .stage {
        position: relative;
        flex: 0 0 auto;
        min-height: 0; /* allow flex child to shrink under mobile chrome */
        width: 95%;
        height: 78svh; /* 80% of visible viewport height */
        max-width: 600px;
        margin: 0 auto; /* center horizontally */
      }
      canvas.stage-layer {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        touch-action: none;
      }
      .hud {
        position: absolute;
        left: 10px;
        bottom: calc(env(safe-area-inset-bottom) + -40px);
        display: flex;
        gap: 4px;
      }

      .hud button {
        font-size: 18px;
        border: 0;
        background: transparent;
        color: #000;
        text-transform: uppercase;
        padding: 4px 8px;
        font-family: "ArchimotoV01-Regular", monospace, -apple-system, Segoe UI,
          Roboto, Helvetica, Arial, sans-serif;
      }

      .spray-cans {
        position: absolute;
        right: 10px;
        bottom: calc(env(safe-area-inset-bottom) - 45px);
        display: flex;
        gap: 10px;
      }

      .spray-cans img {
        width: 45px;
        height: auto;
        cursor: pointer;
        transition: box-shadow 0.2s ease, outline-color 0.2s ease;
      }

      @media (min-width: 768px) {
        .stencil-chip {
          font-size: 15px;
        }
      }

      #controls {
        display: none;
      }

      /* Accordion styles */
      .control-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.1);
        cursor: pointer;
        user-select: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .control-header h3 {
        margin: 0;
        color: white;
        font-size: 16px;
        font-weight: 600;
      }

      .toggle-icon {
        color: white;
        font-size: 14px;
        transition: transform 0.3s ease;
      }

      .control-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        margin-top: 20px;
      }

      .control-content.expanded {
        max-height: 1000px;
      }

      .control-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
      }

      /* Instagram debug log panel */
      #igLogPanel {
        position: fixed;
        left: 12px;
        bottom: 12px;
        width: min(90vw, 360px);
        max-height: 40vh;
        background: rgba(0, 0, 0, 0.75);
        color: #eee;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 8px;
        z-index: 10000;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 11px;
        display: none;
      }
      #igLogPanel header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
        margin-bottom: 6px;
      }
      #igLogPanel header .btns button {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
      }
      #igLogPanel pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        overflow: auto;
        max-height: 30vh;
      }
      #igLogToggle {
        position: fixed;
        left: 12px;
        bottom: 12px;
        z-index: 10001;
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.2);
        background: rgba(255, 255, 255, 0.85);
        color: #111;
      }
    </style>
  </head>
  <body class="stencils">
    <div id="stencilApp">
      <div class="stage">
        <div class="tray" id="stencilTray" style="display: none"></div>
        <!-- Layers: guide > stroke > paint -->
        <canvas id="paintCanvas" class="stage-layer"></canvas>
        <canvas id="strokeCanvas" class="stage-layer"></canvas>
        <canvas id="guideCanvas" class="stage-layer"></canvas>

        <div class="hud">
          <button class="reset-btn">Reset</button>
          <button id="postBtn" class="post-btn">Post</button>
        </div>

        <div class="spray-cans">
          <img
            src="assets/spray-can-gold.png"
            alt="Spray Can Gold"
            class="spray-can-gold"
          />
          <img
            src="assets/spray-can-black.png"
            alt="Spray Can Black"
            class="spray-can-black"
          />
        </div>
      </div>
      <!-- Controls Panel (copied from index.html) -->
      <div id="controls" style="background: rgba(0, 0, 0, 0.85)">
        <div class="control-header" onclick="toggleControls()">
          <h3>Spray Controls</h3>
          <div class="toggle-icon">▼</div>
        </div>
        <div class="control-content" id="controlContent">
          <div class="control-group">
            <label>Preset Colors:</label>
            <div class="color-presets">
              <button
                id="blackColorBtn"
                class="color-preset-btn active"
                style="background-color: #221f20"
                title="Black"
              ></button>

              <button
                id="goldColorBtn"
                class="color-preset-btn"
                style="background-color: #eac677"
                title="Gold"
              ></button>
            </div>
          </div>

          <div class="control-group">
            <label for="nozzleSlider">Nozzle Size:</label>
            <input type="range" id="nozzleSlider" min="2" max="120" value="8" />
            <span id="nozzleValue">8</span>
          </div>

          <div class="control-group">
            <label for="softnessSlider">Softness:</label>
            <input
              type="range"
              id="softnessSlider"
              min="70"
              max="95"
              value="95"
            />
            <span id="softnessValue">95%</span>
          </div>

          <div class="control-group">
            <label for="opacitySlider">Opacity:</label>
            <input
              type="range"
              id="opacitySlider"
              min="80"
              max="100"
              value="100"
            />
            <span id="opacityValue">100%</span>
          </div>

          <div class="control-group">
            <label for="flowSlider">Flow:</label>
            <input
              type="range"
              id="flowSlider"
              min="80"
              max="120"
              value="120"
            />
            <span id="flowValue">120%</span>
          </div>

          <div class="control-group">
            <label for="scatterRadiusSlider">Scatter Radius:</label>
            <input
              type="range"
              id="scatterRadiusSlider"
              min="100"
              max="200"
              value="200"
            />
            <span id="scatterRadiusValue">200%</span>
          </div>

          <div class="control-group">
            <label for="scatterAmountSlider">Scatter Amount:</label>
            <input
              type="range"
              id="scatterAmountSlider"
              min="20"
              max="100"
              value="100"
            />
            <span id="scatterAmountValue">100%</span>
          </div>

          <div class="control-group">
            <label for="scatterSizeSlider">Scatter Size:</label>
            <input
              type="range"
              id="scatterSizeSlider"
              min="50"
              max="150"
              value="150"
            />
            <span id="scatterSizeValue">150%</span>
          </div>

          <div class="control-group">
            <label for="overspraySlider">Overspray:</label>
            <input
              type="range"
              id="overspraySlider"
              min="0"
              max="100"
              value="100"
            />
            <span id="oversprayValue">100%</span>
          </div>

          <div class="control-group">
            <label for="distanceSlider">Distance:</label>
            <input
              type="range"
              id="distanceSlider"
              min="6"
              max="50"
              value="6"
            />
            <span id="distanceValue">6px</span>
          </div>

          <div class="control-group">
            <label for="dripThresholdSlider">Drip Threshold:</label>
            <input
              type="range"
              id="dripThresholdSlider"
              min="10"
              max="65"
              value="59"
            />
            <span id="dripThresholdValue">59%</span>
          </div>

          <div class="control-group">
            <label for="dripGravitySlider">Drip Gravity:</label>
            <input
              type="range"
              id="dripGravitySlider"
              min="500"
              max="3000"
              value="500"
            />
            <span id="dripGravityValue">500</span>
          </div>

          <div class="control-group">
            <label for="dripViscositySlider">Drip Viscosity:</label>
            <input
              type="range"
              id="dripViscositySlider"
              min="1"
              max="10"
              value="8.9"
              step="0.1"
            />
            <span id="dripViscosityValue">8.9</span>
          </div>

          <div class="control-group">
            <label for="dripEvaporationSlider">Drip Evaporation:</label>
            <input
              type="range"
              id="dripEvaporationSlider"
              min="5"
              max="50"
              value="41"
              step="0.1"
            />
            <span id="dripEvaporationValue">0.41</span>
          </div>

          <div class="control-group">
            <button id="dripToggleBtn">Toggle Drips</button>
          </div>

          <div class="control-group">
            <button id="clearBtn">Clear</button>
            <button id="exportBtn">Export PNG</button>
          </div>
          <div class="control-group">
            <button
              id="clipToggle"
              title="Toggle clipping to selected stencil(s)"
            >
              Clip: Off
            </button>
          </div>
        </div>
      </div>
      <!-- IG debug toggle & panel (optional) -->
      <button id="igLogToggle" title="Toggle Instagram debug log">
        IG Logs
      </button>
      <div id="igLogPanel">
        <header>
          <strong>Instagram Deep-Link Logs</strong>
          <div class="btns">
            <button id="igCopyLogs">Copy</button>
            <button id="igClearLogs">Clear</button>
          </div>
        </header>
        <pre id="igLogOutput"></pre>
      </div>
    </div>

    <script src="js/spray.js"></script>
    <script src="js/stencil-app.js"></script>
    <script>
      function toggleControls() {
        const content = document.getElementById("controlContent");
        const header = document.querySelector(".control-header");

        if (content.classList.contains("expanded")) {
          content.classList.remove("expanded");
          header.classList.add("collapsed");
        } else {
          content.classList.add("expanded");
          header.classList.remove("collapsed");
        }
      }

      // Initialize accordion as collapsed
      document.addEventListener("DOMContentLoaded", function () {
        const header = document.querySelector(".control-header");
        header.classList.add("collapsed");

        // --- IG logging helpers ---
        const logs = (window.__igLogs = window.__igLogs || []);
        const out = document.getElementById("igLogOutput");
        const panel = document.getElementById("igLogPanel");
        const toggleBtn = document.getElementById("igLogToggle");
        const copyBtn = document.getElementById("igCopyLogs");
        const clearBtn = document.getElementById("igClearLogs");
        const igLog = (msg) => {
          const ts = new Date().toISOString();
          const line = `[${ts}] ${msg}`;
          logs.push(line);
          try {
            console.log("[IG]", msg);
          } catch (_) {}
          if (out) out.textContent = logs.join("\n");
        };
        const copyLogs = async () => {
          const text = logs.join("\n");
          try {
            await navigator.clipboard.writeText(text);
            igLog("Copied logs to clipboard.");
          } catch (e) {
            const ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try {
              document.execCommand("copy");
              igLog("Copied logs via fallback.");
            } catch (_) {}
            document.body.removeChild(ta);
          }
        };
        const clearLogs = () => {
          logs.length = 0;
          if (out) out.textContent = "";
        };
        if (toggleBtn)
          toggleBtn.addEventListener("click", () => {
            panel.style.display =
              panel.style.display === "none" ? "block" : "none";
          });
        if (copyBtn) copyBtn.addEventListener("click", copyLogs);
        if (clearBtn) clearBtn.addEventListener("click", clearLogs);

        igLog("DOMContentLoaded");
        igLog(`UA=${navigator.userAgent}`);
        document.addEventListener("visibilitychange", () =>
          igLog(`visibilitychange hidden=${document.hidden}`)
        );
        window.addEventListener("pagehide", () => igLog("pagehide"));
        window.addEventListener("blur", () => igLog("window blur"));
        window.addEventListener("focus", () => igLog("window focus"));

        // Attempt to open Instagram camera/library right after export
        const exportBtn = document.getElementById("postBtn");
        const detectIOS = () => {
          const ua = navigator.userAgent || "";
          const hasTouch = (navigator.maxTouchPoints || 0) > 0;
          const iPhoneIPod = /iPhone|iPod/.test(ua);
          const iPadClassic = /iPad/.test(ua);
          const macTouchiPad =
            ua.includes("Macintosh") && (navigator.maxTouchPoints || 0) > 1; // iPadOS masquerading as Mac
          const iOSAltMobile =
            /(CriOS|FxiOS|EdgiOS|GSA)/.test(ua) && /Mobile/.test(ua);
          const desktopMac = /Macintosh|Mac OS X/.test(ua) && !hasTouch; // classic desktop
          const isiOS =
            (iPhoneIPod || iPadClassic || macTouchiPad || iOSAltMobile) &&
            !desktopMac;
          let rule = "unknown";
          if (iPhoneIPod) rule = "iPhone|iPod";
          else if (iPadClassic) rule = "iPad";
          else if (macTouchiPad) rule = "Macintosh+iPad touch";
          else if (iOSAltMobile)
            rule = "Alt iOS UA (CriOS/FxiOS/EdgiOS/GSA)+Mobile";
          else if (desktopMac) rule = "Desktop Mac (excluded)";
          return { isiOS, rule };
        };
        const openInstagram = () => {
          const ua = navigator.userAgent || "";
          const { isiOS, rule } = detectIOS();
          const isAndroid = /Android/.test(ua);
          const iosStore = "https://apps.apple.com/app/instagram/id389801252";
          const androidStore =
            "https://play.google.com/store/apps/details?id=com.instagram.android";

          igLog(`ua=${ua}`);
          igLog(`detect: isiOS=${isiOS} (rule=${rule}) isAndroid=${isAndroid}`);

          // small delay to let the image finish saving so it appears first
          setTimeout(() => {
            if (isiOS) {
              igLog("iOS detected. Attempting instagram://camera");
              const beforeHidden = document.hidden;
              window.location.href = "instagram://camera";
              setTimeout(() => {
                igLog(
                  `post-deeplink hidden=${document.hidden} (before=${beforeHidden})`
                );
                setTimeout(() => {
                  if (!document.hidden) {
                    igLog("App likely not opened, redirecting to App Store");
                    window.location.href = iosStore;
                  } else {
                    igLog(
                      "Likely switched to Instagram app successfully (hidden=true)"
                    );
                  }
                }, 1200);
              }, 1200);
            } else if (isAndroid) {
              // Android fallback: prefer intent link as requested, then scheme
              igLog("Android detected. Trying intent://com.instagram.android first");
              const intentUrl =
                "intent://com.instagram.android/some/path/#Intent;package=com.instagram.android;scheme=https;end";
              const a = document.createElement("a");
              a.href = intentUrl;
              a.rel = "noopener";
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);

              setTimeout(() => {
                if (document.hidden) {
                  igLog("intent seemed to switch (hidden=true)");
                  return;
                }
                igLog("Intent did not switch; trying instagram://camera");
                const beforeHiddenScheme = document.hidden;
                window.location.href = "instagram://camera";
                setTimeout(() => {
                  igLog(
                    `post-deeplink (scheme) hidden=${document.hidden} (before=${beforeHiddenScheme})`
                  );
                }, 900);
              }, 800);
            }
          }, 600);
        };

        if (exportBtn) {
          exportBtn.addEventListener("click", () => {
            // The actual PNG export is handled in JS; we only deep-link IG after click
            igLog("Export clicked → scheduling IG open");
            openInstagram();
          });
        }
      });
    </script>
  </body>
</html>
